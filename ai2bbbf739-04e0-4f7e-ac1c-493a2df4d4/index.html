<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT 4o mini</title>

    <link rel="stylesheet" href="../css/atom-one-dark.min.css">

    <link rel="stylesheet" href="./css/chat-home.css">

    <script src="../js/lib/crypto-js.min.js"></script>
    <script src="../js/lib/jquery-3.6.0.min.js"></script>
    <script src="../js/lib/marked.min.js"></script>
    <script src="../js/lib/highlight.min.js"></script>

    <script src="./js/ai/ag-ai.js"></script>
</head>

<body>
    <textarea id="data" hidden="hidden"></textarea>
    <div class="chat-container">
        <div class="chat-history" id="chatHistory"></div>
        <div class="input-area">
            <input type="text" class="input-text" id="messageInput" placeholder="输入消息...">
            <button class="send-button" id="sendButton">发送</button>
        </div>
    </div>

    <script>
        let answerCount = 0;
        const history = [];

        function getUrlParameter(name) {
            // 使用正则表达式从 URL 中提取参数
            const regex = new RegExp('[?&]' + encodeURIComponent(name) + '=([^&]*)', 'i');
            const results = regex.exec(window.location.href);
            return results ? decodeURIComponent(results[1]) : null;
        }

        function decrypt(content, key) {
            return CryptoJS.AES.decrypt(content, CryptoJS.enc.Utf8.parse(key), {
                mode: CryptoJS.mode.ECB,
                padding: CryptoJS.pad.Pkcs7
            }).toString(CryptoJS.enc.Utf8);
        }

        function getData() {
            return $("#data").text();
        }

        $(document).ready(function () {
            const key = getUrlParameter('key');
            if (!key) {
                alert('Empty key');
                return;
            }
            const encryData = "b53kNat6fcv/LggZAfXnG4Zz3hLxxF45eDQOeRXN5Aqq22yL83gKZBUTBjiamHjZo61xTC29AaZ22IQu5ux2cLvxaIVDjem0WduAb6qteXMkNIVbIXu4l50bXBV8ae1WS2PSYNGA4DTgDqOrSCCmZkvhYXMnEYsESyhJ7qt8rdk8URuRtlBQvEjBYPB/qXQ0S2PSYNGA4DTgDqOrSCCmZgk0jQC8xR8sKYhBiDps3UIIkekfosjDEr9RirttZPjZKKaOTSL0v7zeIkUhsIp4ggLQhaU3DNc77UDwRPVYxv4QQoiR2G2GvIlvYjJdY5QgkV1BqkDjoOVrzD5rUZX4/nFITNRexJOp8TL1VCWnr/4geLB+pQJWyl/9FmhG9bH09smEPd62GbZK7sRIaPXQTYx4Ptzr8r0VoSaelY/az8MnJn9c0bJN5PPQjNQ+Nak7";
            const data = decrypt(encryData, key);
            $("#data").text(data)

            $('#sendButton').click(function () {
                const message = $('#messageInput').val();
                if (message.trim() !== '') {
                    appendMessage('sent', message);
                    $('#messageInput').val('');
                    request(message);
                }
            });

            function appendMessage(type, message) {
                answerCount++;
                const answerId = 'answer' + answerCount;
                const messageHtml = `
                    <div class="message ${type}">
                        ${type === 'received' ? '<img src="./images/robot.png">' : ''}
                        <div class="message-content" id = ${answerId}>${message}</div>
                        ${type === 'sent' ? '<img src="./images/user.png">' : ''}
                    </div>`;
                $('#chatHistory').append(messageHtml);
                $('#chatHistory').scrollTop($('#chatHistory')[0].scrollHeight);
                // hljs.highlightAll();

                // 高亮
                const codeBlocks = document.getElementById(answerId).getElementsByTagName('code');
                if (codeBlocks && codeBlocks.length > 0) {
                    for (const codeBlock of codeBlocks) {
                        hljs.highlightElement(codeBlock);
                    }
                }
            }

            function request(question) {
                const data = JSON.parse(getData());
                const authToken = data['auth-token'];

                $('#sendButton').attr('diabled', 'diabled');
                $('#sendButton').text('发送中...');

                const ai = new AGAI(data);
                ai.chat('', question, history, function (res) {
                    // const responseMessage = "这是一个回复: " + sentMessage;
                    appendMessage('received', marked.marked(res));
                    // appendMessage('received', mdToHtml(res));
                    $('#sendButton').attr('diabled', '');
                    $('#sendButton').text('发送');

                    // 加入历史
                    history.push({ role: 'user', content: question });
                    history.push({ role: 'assistant', content: res });
                });
            }
        });
    </script>
</body>

</html>